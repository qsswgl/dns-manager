# 自动证书续期系统 - 最终使用说明

## ✅ 已完成配置

### 服务器信息
- **服务器**: www.qsgl.cn (123.57.93.200)
- **当前域名**: qsgl.cn
- **泛域名证书**: *.qsgl.cn
- **代理端口**: 8443 (对外) → 443 (容器内)
- **后端服务**: https://61.163.200.245
- **绑定域名**: www.qsgl.net

### 证书类型
- **算法**: RSA 2048 (Envoy 不支持 EC 私钥)
- **格式**: X.509 PEM
- **有效期**: 90天

---

## 📁 已部署文件

### 服务器端文件
```bash
# 域名配置文件
/etc/envoy-domain.conf                    # 配置当前使用的域名

# 证书续期脚本
/usr/local/bin/renew-qsgl-cert.sh        # 自动续期主脚本

# Envoy 配置
/opt/envoy/envoy.yaml                     # Envoy 主配置文件

# 证书文件
/opt/envoy/certs/qsgl.cn.crt             # 当前域名的证书
/opt/envoy/certs/qsgl.cn.key             # 当前域名的私钥

# 日志文件
/var/log/cert-renewal.log                # 续期日志
```

---

## 🚀 使用方法

### 1. 修改代理域名

当你需要更换代理域名时（例如从 qsgl.cn 改为 qsgl.net）：

```bash
# 方法1: SSH 登录服务器修改配置文件
ssh root@www.qsgl.cn
echo "qsgl.net" > /etc/envoy-domain.conf

# 方法2: 直接通过 SSH 命令
ssh root@www.qsgl.cn "echo qsgl.net > /etc/envoy-domain.conf"
```

### 2. 生成新域名证书

修改域名后，运行续期脚本生成对应的证书：

```bash
# 登录服务器
ssh root@www.qsgl.cn

# 运行续期脚本
/usr/local/bin/renew-qsgl-cert.sh

# 脚本会自动:
# 1. 读取 /etc/envoy-domain.conf 中的域名
# 2. 调用 https://tx.qsgl.net:5075/api/request-cert
# 3. 生成 /opt/envoy/certs/[域名].crt 和 .key
# 4. 重启 Envoy 容器
```

### 3. 更新 Envoy 配置

如果域名改变，需要更新 Envoy 配置文件中的证书路径：

```bash
# 自动生成新的 Envoy 配置（推荐）
/usr/local/bin/generate-envoy-config.sh

# 应用新配置
docker cp /opt/envoy/envoy.yaml envoy-proxy:/etc/envoy/envoy.yaml
docker restart envoy-proxy
```

或者手动修改 `/opt/envoy/envoy.yaml`：
```yaml
# 将所有证书路径改为新域名
certificate_chain: { filename: "/etc/envoy/certs/qsgl.net.crt" }
private_key:      { filename: "/etc/envoy/certs/qsgl.net.key" }
```

---

## 🔄 自动化流程示例

### 完整切换域名流程：

```bash
# 假设要从 qsgl.cn 切换到 qsgl.net

# 步骤1: 更新域名配置
ssh root@www.qsgl.cn "echo qsgl.net > /etc/envoy-domain.conf"

# 步骤2: 生成新证书
ssh root@www.qsgl.cn "/usr/local/bin/renew-qsgl-cert.sh"

# 步骤3: 更新 Envoy 配置并重启
ssh root@www.qsgl.cn "
  # 更新配置中的证书文件名
  sed -i 's/qsgl\.cn\./qsgl.net./g' /opt/envoy/envoy.yaml
  
  # 应用到容器
  docker cp /opt/envoy/envoy.yaml envoy-proxy:/etc/envoy/envoy.yaml
  
  # 重启 Envoy
  docker restart envoy-proxy
  
  # 等待启动
  sleep 3
  
  # 测试
  curl -skI https://localhost:8443/ -H 'Host: www.qsgl.net' | head -n 5
"
```

---

## 📊 验证与测试

### 检查当前配置
```bash
# 查看当前使用的域名
ssh root@www.qsgl.cn "cat /etc/envoy-domain.conf"

# 查看证书文件
ssh root@www.qsgl.cn "ls -lh /opt/envoy/certs/"

# 查看证书详情
ssh root@www.qsgl.cn "openssl x509 -in /opt/envoy/certs/qsgl.cn.crt -noout -subject -dates -ext subjectAltName"
```

### 测试 8443 端口
```bash
# 从服务器本地测试
ssh root@www.qsgl.cn "curl -skI https://localhost:8443/ -H 'Host: www.qsgl.cn'"

# 从外部测试 (Windows curl)
curl.exe -k -I https://www.qsgl.cn:8443/ -H "Host: www.qsgl.cn"
```

### 查看日志
```bash
# 续期日志
ssh root@www.qsgl.cn "tail -f /var/log/cert-renewal.log"

# Envoy 日志
ssh root@www.qsgl.cn "docker logs --tail 50 envoy-proxy"

# Envoy 实时日志
ssh root@www.qsgl.cn "docker logs -f envoy-proxy"
```

---

## ⚙️ API 调用说明

续期脚本会自动调用证书 API：

**API 端点**: `https://tx.qsgl.net:5075/api/request-cert`

**请求参数**:
```bash
POST /api/request-cert
Content-Type: application/x-www-form-urlencoded

domain=qsgl.cn&provider=DNSPod
```

**响应示例**:
```json
{
  "success": true,
  "msg": "✅ 泛域名证书申请成功！",
  "subject": "*.qsgl.cn",
  "domain": "qsgl.cn",
  "provider": "DNSPod",
  "isWildcard": true,
  "cert": "-----BEGIN CERTIFICATE-----\n...",
  "key": "-----BEGIN EC PRIVATE KEY-----\n...",
  "timestamp": "2025-10-19T13:56:58Z"
}
```

**注意事项**:
- API 返回的是 ECDSA 证书
- 续期脚本会自动转换为 RSA 2048（Envoy 兼容性）
- 如果 API 失败，会自动生成本地自签证书作为回退

---

## 🔐 安全说明

### 证书文件权限
```bash
/opt/envoy/certs/*.crt    644 (rw-r--r--)  # 证书公钥可读
/opt/envoy/certs/*.key    600 (rw-------)  # 私钥仅 root 可读
```

### 推荐的定期任务
```bash
# 编辑 crontab
crontab -e

# 添加每天凌晨 3 点自动续期
0 3 * * * /usr/local/bin/renew-qsgl-cert.sh >> /var/log/cert-renewal.log 2>&1
```

---

## 🎯 快速命令参考

```bash
# 查看当前域名
cat /etc/envoy-domain.conf

# 修改域名
echo "新域名" > /etc/envoy-domain.conf

# 生成证书
/usr/local/bin/renew-qsgl-cert.sh

# 重启 Envoy
docker restart envoy-proxy

# 测试服务
curl -skI https://localhost:8443/ -H "Host: www.$(cat /etc/envoy-domain.conf)"

# 查看日志
tail -f /var/log/cert-renewal.log
```

---

## 🐛 故障排查

### 问题: Envoy 启动失败
```bash
# 查看日志
docker logs --tail 50 envoy-proxy

# 常见错误: "Failed to load incomplete private key"
# 原因: EC 私钥不兼容
# 解决: 重新生成 RSA 证书
cd /opt/envoy/certs
openssl genrsa -out $(cat /etc/envoy-domain.conf).key 2048
openssl req -new -x509 -key $(cat /etc/envoy-domain.conf).key -sha256 -days 90 \
  -out $(cat /etc/envoy-domain.conf).crt \
  -subj "/CN=*.$(cat /etc/envoy-domain.conf)" \
  -addext "subjectAltName=DNS:$(cat /etc/envoy-domain.conf),DNS:*.$(cat /etc/envoy-domain.conf)"
chmod 644 *.crt && chmod 600 *.key
docker restart envoy-proxy
```

### 问题: 8443 端口无法访问
```bash
# 检查端口映射
docker port envoy-proxy

# 检查防火墙
iptables -L -n | grep 8443

# 检查 Envoy 是否运行
docker ps | grep envoy

# 检查证书是否匹配
openssl s_client -connect localhost:8443 -servername www.$(cat /etc/envoy-domain.conf) < /dev/null
```

---

**最后更新**: 2025年10月19日  
**当前状态**: ✅ 正常运行  
**当前域名**: qsgl.cn
