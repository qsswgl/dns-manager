# DNS API æœåŠ¡é¢‘ç¹åœæ­¢é—®é¢˜æ ¹å› åˆ†æ

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**: https://tx.qsgl.net:5075 ç»å¸¸æ— æ³•è®¿é—®ï¼ŒæœåŠ¡åœæ­¢è¿è¡Œ

**å‘ç”Ÿæ—¶é—´**: 2025å¹´10æœˆ24æ—¥å‘ç°ï¼Œå®¹å™¨å·²åœæ­¢ 22 å°æ—¶

**å½±å“èŒƒå›´**: 
- HTTPS API æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- DNS åŠ¨æ€æ›´æ–°åŠŸèƒ½ä¸­æ–­
- è¯ä¹¦ç®¡ç†åŠŸèƒ½æ— æ³•è®¿é—®

---

## ğŸ” æ ¹å› åˆ†æ

### 1. **ç›´æ¥åŸå› ï¼šå®¹å™¨æœªé…ç½®è‡ªåŠ¨é‡å¯ç­–ç•¥**

**å‘ç°è¿‡ç¨‹**ï¼š
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a | grep dnsapi
# è¾“å‡º: Exited (0) 22 hours ago

# æ£€æŸ¥é‡å¯ç­–ç•¥
docker inspect dnsapi --format='{{.HostConfig.RestartPolicy.Name}}'
# è¾“å‡º: no
```

**é—®é¢˜è¯´æ˜**ï¼š
- Docker å®¹å™¨çš„é‡å¯ç­–ç•¥è®¾ç½®ä¸º `no`
- è¿™æ„å‘³ç€å®¹å™¨åœæ­¢å**ä¸ä¼šè‡ªåŠ¨é‡å¯**
- ä»»ä½•å¯¼è‡´å®¹å™¨åœæ­¢çš„äº‹ä»¶ï¼ˆå¦‚ç³»ç»Ÿé‡å¯ã€æ‰‹åŠ¨åœæ­¢ã€åº”ç”¨å´©æºƒç­‰ï¼‰éƒ½ä¼šå¯¼è‡´æœåŠ¡é•¿æ—¶é—´ä¸å¯ç”¨

### 2. **å®¹å™¨åœæ­¢çš„åŸå› **

**æ—¥å¿—åˆ†æ**ï¼š
```
æœ€åä¸€æ¡æ—¥å¿—: info: Microsoft.Hosting.Lifetime[0]
      Application is shutting down...
```

**å¯èƒ½çš„åœæ­¢åŸå› **ï¼š
1. âœ… **æ­£å¸¸å…³é—­** - æ—¥å¿—æ˜¾ç¤ºæ˜¯æ­£å¸¸çš„åº”ç”¨å…³é—­æµç¨‹
2. å¯èƒ½è§¦å‘å› ç´ ï¼š
   - ç³»ç»Ÿç»´æŠ¤æˆ–é‡å¯
   - æ‰‹åŠ¨ `docker stop` å‘½ä»¤
   - èµ„æºä¸è¶³è§¦å‘ OOM Killer
   - Docker æœåŠ¡é‡å¯
   - ç³»ç»Ÿæ›´æ–°

### 3. **ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰é—®é¢˜ï¼Ÿ**

æŸ¥çœ‹å†å²éƒ¨ç½²å‘½ä»¤ï¼Œå‘ç°é—®é¢˜ï¼š

**ä¹‹å‰çš„éƒ¨ç½²å‘½ä»¤ï¼ˆç¼ºå°‘é‡å¯ç­–ç•¥ï¼‰**ï¼š
```bash
docker run -d \
  --name dnsapi \
  -p 5074:5074 \
  -p 5075:5075 \
  -v /opt/shared-certs:/opt/shared-certs:ro \
  -v /etc/hosts:/etc/hosts:ro \
  43.138.35.183:5000/dnsapi:cert-manager-v3
```

**åº”è¯¥ä½¿ç”¨çš„å‘½ä»¤ï¼ˆåŒ…å«é‡å¯ç­–ç•¥ï¼‰**ï¼š
```bash
docker run -d \
  --name dnsapi \
  --restart=unless-stopped \  # â† ç¼ºå°‘è¿™ä¸€è¡Œï¼
  -p 5074:5074 \
  -p 5075:5075 \
  -v /opt/shared-certs:/opt/shared-certs:ro \
  -v /etc/hosts:/etc/hosts:ro \
  43.138.35.183:5000/dnsapi:cert-manager-v3
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ç«‹å³ä¿®å¤ï¼ˆå·²æ‰§è¡Œï¼‰

```bash
# 1. å¯åŠ¨å®¹å™¨
docker start dnsapi

# 2. è®¾ç½®è‡ªåŠ¨é‡å¯ç­–ç•¥
docker update --restart=unless-stopped dnsapi

# 3. éªŒè¯
docker ps | grep dnsapi
docker inspect dnsapi --format='{{.HostConfig.RestartPolicy.Name}}'
```

**æ‰§è¡Œç»“æœ**ï¼š
- âœ… å®¹å™¨å·²å¯åŠ¨
- âœ… é‡å¯ç­–ç•¥å·²è®¾ç½®ä¸º `unless-stopped`
- âœ… HTTPS æœåŠ¡æ¢å¤æ­£å¸¸

### Docker é‡å¯ç­–ç•¥è¯´æ˜

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `no` | âŒ ä¸è‡ªåŠ¨é‡å¯ | ä»…æµ‹è¯•ç¯å¢ƒ |
| `always` | å§‹ç»ˆé‡å¯ | éœ€è¦æ°¸è¿œè¿è¡Œçš„æœåŠ¡ |
| `unless-stopped` | é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯ | **âœ… æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ** |
| `on-failure` | ä»…åœ¨å¤±è´¥æ—¶é‡å¯ | ä¸´æ—¶ä»»åŠ¡ |

**é€‰æ‹© `unless-stopped` çš„åŸå› **ï¼š
- ç³»ç»Ÿé‡å¯åè‡ªåŠ¨å¯åŠ¨
- æ„å¤–å´©æºƒåè‡ªåŠ¨æ¢å¤
- å…è®¸æ‰‹åŠ¨åœæ­¢ç»´æŠ¤ï¼ˆä¸ä¼šè‡ªåŠ¨é‡å¯ï¼‰
- æœ€é€‚åˆç”Ÿäº§ç¯å¢ƒçš„ Web æœåŠ¡

---

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. **éƒ¨ç½²æ£€æŸ¥æ¸…å•**

åˆ›å»ºæ ‡å‡†éƒ¨ç½²æµç¨‹ï¼Œç¡®ä¿æ¯æ¬¡éƒ¨ç½²éƒ½åŒ…å«ï¼š

```bash
# éƒ¨ç½²æ£€æŸ¥æ¸…å•
â–¡ æŒ‡å®š --restart=unless-stopped
â–¡ é…ç½®å¥åº·æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
â–¡ è®¾ç½®èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼‰
â–¡ æŒ‚è½½å¿…è¦çš„å·
â–¡ é…ç½®æ­£ç¡®çš„ç«¯å£æ˜ å°„
â–¡ éªŒè¯å®¹å™¨å¯åŠ¨æˆåŠŸ
```

### 2. **æ·»åŠ å¥åº·æ£€æŸ¥ï¼ˆå»ºè®®ï¼‰**

ä¿®æ”¹ Dockerfile æˆ–è¿è¡Œå‘½ä»¤ï¼š

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:5074/api/health || exit 1
```

æˆ–åœ¨è¿è¡Œæ—¶æ·»åŠ ï¼š
```bash
docker run -d \
  --name dnsapi \
  --restart=unless-stopped \
  --health-cmd='curl -f http://localhost:5074/api/health || exit 1' \
  --health-interval=30s \
  --health-timeout=3s \
  --health-retries=3 \
  ...
```

### 3. **ç›‘æ§å’Œå‘Šè­¦**

å»ºè®®é…ç½®ä»¥ä¸‹ç›‘æ§ï¼š

1. **æœåŠ¡å¯ç”¨æ€§ç›‘æ§**
   - æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ https://tx.qsgl.net:5075/api/health
   - å¤±è´¥æ—¶å‘é€å‘Šè­¦

2. **å®¹å™¨çŠ¶æ€ç›‘æ§**
   ```bash
   # å®šæ—¶ä»»åŠ¡æ£€æŸ¥å®¹å™¨çŠ¶æ€
   */5 * * * * docker ps | grep dnsapi || /path/to/alert.sh
   ```

3. **èµ„æºä½¿ç”¨ç›‘æ§**
   ```bash
   # æ£€æŸ¥å†…å­˜å’Œ CPU ä½¿ç”¨
   docker stats --no-stream dnsapi
   ```

### 4. **è‡ªåŠ¨åŒ–è¯Šæ–­è„šæœ¬**

å·²åˆ›å»º `diagnose-and-fix-dnsapi.ps1` è„šæœ¬ï¼Œå¯ä»¥ï¼š
- è‡ªåŠ¨æ£€æµ‹æœåŠ¡çŠ¶æ€
- è¯Šæ–­å¸¸è§é—®é¢˜
- è‡ªåŠ¨ä¿®å¤ï¼ˆä½¿ç”¨ `-AutoFix` å‚æ•°ï¼‰

**ä½¿ç”¨æ–¹æ³•**ï¼š
```powershell
# ä»…è¯Šæ–­
.\diagnose-and-fix-dnsapi.ps1

# è‡ªåŠ¨ä¿®å¤
.\diagnose-and-fix-dnsapi.ps1 -AutoFix
```

---

## ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥

### å½“å‰ç³»ç»Ÿèµ„æºï¼ˆæ­£å¸¸ï¼‰

```
å†…å­˜:
  total: 3.6Gi
  used:  1.1Gi
  free:  458Mi
  available: 2.5Gi

ç£ç›˜:
  æ€»å®¹é‡: 69G
  å·²ä½¿ç”¨: 17G
  å¯ç”¨:   50G
  ä½¿ç”¨ç‡: 26%
```

**ç»“è®º**: ç³»ç»Ÿèµ„æºå……è¶³ï¼Œä¸æ˜¯åœæ­¢çš„åŸå› 

### å®¹å™¨é…ç½®

```yaml
å®¹å™¨åç§°: dnsapi
é•œåƒ: 43.138.35.183:5000/dnsapi:cert-manager-v3
ç«¯å£æ˜ å°„:
  - 5074:5074 (HTTP)
  - 5075:5075 (HTTPS)
æŒ‚è½½å·:
  - /opt/shared-certs:/opt/shared-certs:ro
  - /etc/hosts:/etc/hosts:ro
é‡å¯ç­–ç•¥: unless-stopped âœ…
```

---

## ğŸ”„ æœªæ¥ä¼˜åŒ–å»ºè®®

### 1. **ä½¿ç”¨ Docker Compose**

åˆ›å»º `docker-compose.yml`:

```yaml
version: '3.8'

services:
  dnsapi:
    image: 43.138.35.183:5000/dnsapi:cert-manager-v3
    container_name: dnsapi
    restart: unless-stopped
    ports:
      - "5074:5074"
      - "5075:5075"
    volumes:
      - /opt/shared-certs:/opt/shared-certs:ro
      - /etc/hosts:/etc/hosts:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5074/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

**ä¼˜ç‚¹**ï¼š
- é…ç½®ç»Ÿä¸€ç®¡ç†
- æ˜“äºç‰ˆæœ¬æ§åˆ¶
- ç®€åŒ–éƒ¨ç½²æµç¨‹

### 2. **æ—¥å¿—ç®¡ç†**

å½“å‰æ—¥å¿—å¯èƒ½æ— é™å¢é•¿ï¼Œå»ºè®®é…ç½®ï¼š

```bash
docker update \
  --log-opt max-size=10m \
  --log-opt max-file=3 \
  dnsapi
```

### 3. **èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼‰**

é˜²æ­¢èµ„æºè€—å°½ï¼š

```bash
docker update \
  --memory=2g \
  --memory-swap=2g \
  --cpus=2 \
  dnsapi
```

---

## ğŸ“ æ€»ç»“

### é—®é¢˜æ ¹æº
- **æ ¹æœ¬åŸå› **: Docker å®¹å™¨æœªé…ç½®è‡ªåŠ¨é‡å¯ç­–ç•¥
- **è§¦å‘å› ç´ **: å®¹å™¨å› æŸç§åŸå› åœæ­¢ï¼ˆæ­£å¸¸å…³é—­ï¼‰
- **å½±å“æ—¶é•¿**: 22 å°æ—¶æ— äººå‘ç°

### å·²ä¿®å¤
- âœ… å®¹å™¨å·²é‡å¯
- âœ… è®¾ç½® `--restart=unless-stopped` ç­–ç•¥
- âœ… æœåŠ¡æ¢å¤æ­£å¸¸

### é¢„é˜²æªæ–½
- âœ… åˆ›å»ºè‡ªåŠ¨è¯Šæ–­è„šæœ¬
- âœ… æ–‡æ¡£åŒ–æ ‡å‡†éƒ¨ç½²æµç¨‹
- å»ºè®®: æ·»åŠ ç›‘æ§å‘Šè­¦
- å»ºè®®: ä½¿ç”¨ Docker Compose

### ç»éªŒæ•™è®­
1. **æ‰€æœ‰ç”Ÿäº§å®¹å™¨å¿…é¡»é…ç½®é‡å¯ç­–ç•¥**
2. éƒ¨ç½²åéªŒè¯é‡å¯ç­–ç•¥æ˜¯å¦æ­£ç¡®
3. éœ€è¦ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
4. æ–‡æ¡£åŒ–è¿ç»´æµç¨‹å¾ˆé‡è¦

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- è¯Šæ–­è„šæœ¬: `K:\DNS\diagnose-and-fix-dnsapi.ps1`
- SSH å¯†é’¥: `C:\Key\tx.qsgl.net_id_ed25519`
- æœåŠ¡åœ°å€: https://tx.qsgl.net:5075
- æœåŠ¡å™¨IP: 43.138.35.183

## ğŸ“… æ›´æ–°æ—¥å¿—

- **2025-10-24**: å‘ç°é—®é¢˜å¹¶ä¿®å¤ï¼Œåˆ›å»ºè¯Šæ–­è„šæœ¬å’Œæ­¤æ–‡æ¡£
