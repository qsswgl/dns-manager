# è‡ªåŠ¨è¯ä¹¦ç»­æœŸç³»ç»Ÿ - æœ€ç»ˆä½¿ç”¨è¯´æ˜

## âœ… å·²å®Œæˆé…ç½®

### æœåŠ¡å™¨ä¿¡æ¯
- **æœåŠ¡å™¨**: www.qsgl.cn (123.57.93.200)
- **å½“å‰åŸŸå**: qsgl.cn
- **æ³›åŸŸåè¯ä¹¦**: *.qsgl.cn
- **ä»£ç†ç«¯å£**: 8443 (å¯¹å¤–) â†’ 443 (å®¹å™¨å†…)
- **åç«¯æœåŠ¡**: https://61.163.200.245
- **ç»‘å®šåŸŸå**: www.qsgl.net

### è¯ä¹¦ç±»å‹
- **ç®—æ³•**: RSA 2048 (Envoy ä¸æ”¯æŒ EC ç§é’¥)
- **æ ¼å¼**: X.509 PEM
- **æœ‰æ•ˆæœŸ**: 90å¤©

---

## ğŸ“ å·²éƒ¨ç½²æ–‡ä»¶

### æœåŠ¡å™¨ç«¯æ–‡ä»¶
```bash
# åŸŸåé…ç½®æ–‡ä»¶
/etc/envoy-domain.conf                    # é…ç½®å½“å‰ä½¿ç”¨çš„åŸŸå

# è¯ä¹¦ç»­æœŸè„šæœ¬
/usr/local/bin/renew-qsgl-cert.sh        # è‡ªåŠ¨ç»­æœŸä¸»è„šæœ¬

# Envoy é…ç½®
/opt/envoy/envoy.yaml                     # Envoy ä¸»é…ç½®æ–‡ä»¶

# è¯ä¹¦æ–‡ä»¶
/opt/envoy/certs/qsgl.cn.crt             # å½“å‰åŸŸåçš„è¯ä¹¦
/opt/envoy/certs/qsgl.cn.key             # å½“å‰åŸŸåçš„ç§é’¥

# æ—¥å¿—æ–‡ä»¶
/var/log/cert-renewal.log                # ç»­æœŸæ—¥å¿—
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ä¿®æ”¹ä»£ç†åŸŸå

å½“ä½ éœ€è¦æ›´æ¢ä»£ç†åŸŸåæ—¶ï¼ˆä¾‹å¦‚ä» qsgl.cn æ”¹ä¸º qsgl.netï¼‰ï¼š

```bash
# æ–¹æ³•1: SSH ç™»å½•æœåŠ¡å™¨ä¿®æ”¹é…ç½®æ–‡ä»¶
ssh root@www.qsgl.cn
echo "qsgl.net" > /etc/envoy-domain.conf

# æ–¹æ³•2: ç›´æ¥é€šè¿‡ SSH å‘½ä»¤
ssh root@www.qsgl.cn "echo qsgl.net > /etc/envoy-domain.conf"
```

### 2. ç”Ÿæˆæ–°åŸŸåè¯ä¹¦

ä¿®æ”¹åŸŸååï¼Œè¿è¡Œç»­æœŸè„šæœ¬ç”Ÿæˆå¯¹åº”çš„è¯ä¹¦ï¼š

```bash
# ç™»å½•æœåŠ¡å™¨
ssh root@www.qsgl.cn

# è¿è¡Œç»­æœŸè„šæœ¬
/usr/local/bin/renew-qsgl-cert.sh

# è„šæœ¬ä¼šè‡ªåŠ¨:
# 1. è¯»å– /etc/envoy-domain.conf ä¸­çš„åŸŸå
# 2. è°ƒç”¨ https://tx.qsgl.net:5075/api/request-cert
# 3. ç”Ÿæˆ /opt/envoy/certs/[åŸŸå].crt å’Œ .key
# 4. é‡å¯ Envoy å®¹å™¨
```

### 3. æ›´æ–° Envoy é…ç½®

å¦‚æœåŸŸåæ”¹å˜ï¼Œéœ€è¦æ›´æ–° Envoy é…ç½®æ–‡ä»¶ä¸­çš„è¯ä¹¦è·¯å¾„ï¼š

```bash
# è‡ªåŠ¨ç”Ÿæˆæ–°çš„ Envoy é…ç½®ï¼ˆæ¨èï¼‰
/usr/local/bin/generate-envoy-config.sh

# åº”ç”¨æ–°é…ç½®
docker cp /opt/envoy/envoy.yaml envoy-proxy:/etc/envoy/envoy.yaml
docker restart envoy-proxy
```

æˆ–è€…æ‰‹åŠ¨ä¿®æ”¹ `/opt/envoy/envoy.yaml`ï¼š
```yaml
# å°†æ‰€æœ‰è¯ä¹¦è·¯å¾„æ”¹ä¸ºæ–°åŸŸå
certificate_chain: { filename: "/etc/envoy/certs/qsgl.net.crt" }
private_key:      { filename: "/etc/envoy/certs/qsgl.net.key" }
```

---

## ğŸ”„ è‡ªåŠ¨åŒ–æµç¨‹ç¤ºä¾‹

### å®Œæ•´åˆ‡æ¢åŸŸåæµç¨‹ï¼š

```bash
# å‡è®¾è¦ä» qsgl.cn åˆ‡æ¢åˆ° qsgl.net

# æ­¥éª¤1: æ›´æ–°åŸŸåé…ç½®
ssh root@www.qsgl.cn "echo qsgl.net > /etc/envoy-domain.conf"

# æ­¥éª¤2: ç”Ÿæˆæ–°è¯ä¹¦
ssh root@www.qsgl.cn "/usr/local/bin/renew-qsgl-cert.sh"

# æ­¥éª¤3: æ›´æ–° Envoy é…ç½®å¹¶é‡å¯
ssh root@www.qsgl.cn "
  # æ›´æ–°é…ç½®ä¸­çš„è¯ä¹¦æ–‡ä»¶å
  sed -i 's/qsgl\.cn\./qsgl.net./g' /opt/envoy/envoy.yaml
  
  # åº”ç”¨åˆ°å®¹å™¨
  docker cp /opt/envoy/envoy.yaml envoy-proxy:/etc/envoy/envoy.yaml
  
  # é‡å¯ Envoy
  docker restart envoy-proxy
  
  # ç­‰å¾…å¯åŠ¨
  sleep 3
  
  # æµ‹è¯•
  curl -skI https://localhost:8443/ -H 'Host: www.qsgl.net' | head -n 5
"
```

---

## ğŸ“Š éªŒè¯ä¸æµ‹è¯•

### æ£€æŸ¥å½“å‰é…ç½®
```bash
# æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„åŸŸå
ssh root@www.qsgl.cn "cat /etc/envoy-domain.conf"

# æŸ¥çœ‹è¯ä¹¦æ–‡ä»¶
ssh root@www.qsgl.cn "ls -lh /opt/envoy/certs/"

# æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…
ssh root@www.qsgl.cn "openssl x509 -in /opt/envoy/certs/qsgl.cn.crt -noout -subject -dates -ext subjectAltName"
```

### æµ‹è¯• 8443 ç«¯å£
```bash
# ä»æœåŠ¡å™¨æœ¬åœ°æµ‹è¯•
ssh root@www.qsgl.cn "curl -skI https://localhost:8443/ -H 'Host: www.qsgl.cn'"

# ä»å¤–éƒ¨æµ‹è¯• (Windows curl)
curl.exe -k -I https://www.qsgl.cn:8443/ -H "Host: www.qsgl.cn"
```

### æŸ¥çœ‹æ—¥å¿—
```bash
# ç»­æœŸæ—¥å¿—
ssh root@www.qsgl.cn "tail -f /var/log/cert-renewal.log"

# Envoy æ—¥å¿—
ssh root@www.qsgl.cn "docker logs --tail 50 envoy-proxy"

# Envoy å®æ—¶æ—¥å¿—
ssh root@www.qsgl.cn "docker logs -f envoy-proxy"
```

---

## âš™ï¸ API è°ƒç”¨è¯´æ˜

ç»­æœŸè„šæœ¬ä¼šè‡ªåŠ¨è°ƒç”¨è¯ä¹¦ APIï¼š

**API ç«¯ç‚¹**: `https://tx.qsgl.net:5075/api/request-cert`

**è¯·æ±‚å‚æ•°**:
```bash
POST /api/request-cert
Content-Type: application/x-www-form-urlencoded

domain=qsgl.cn&provider=DNSPod
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "msg": "âœ… æ³›åŸŸåè¯ä¹¦ç”³è¯·æˆåŠŸï¼",
  "subject": "*.qsgl.cn",
  "domain": "qsgl.cn",
  "provider": "DNSPod",
  "isWildcard": true,
  "cert": "-----BEGIN CERTIFICATE-----\n...",
  "key": "-----BEGIN EC PRIVATE KEY-----\n...",
  "timestamp": "2025-10-19T13:56:58Z"
}
```

**æ³¨æ„äº‹é¡¹**:
- API è¿”å›çš„æ˜¯ ECDSA è¯ä¹¦
- ç»­æœŸè„šæœ¬ä¼šè‡ªåŠ¨è½¬æ¢ä¸º RSA 2048ï¼ˆEnvoy å…¼å®¹æ€§ï¼‰
- å¦‚æœ API å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆæœ¬åœ°è‡ªç­¾è¯ä¹¦ä½œä¸ºå›é€€

---

## ğŸ” å®‰å…¨è¯´æ˜

### è¯ä¹¦æ–‡ä»¶æƒé™
```bash
/opt/envoy/certs/*.crt    644 (rw-r--r--)  # è¯ä¹¦å…¬é’¥å¯è¯»
/opt/envoy/certs/*.key    600 (rw-------)  # ç§é’¥ä»… root å¯è¯»
```

### æ¨èçš„å®šæœŸä»»åŠ¡
```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ æ¯å¤©å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨ç»­æœŸ
0 3 * * * /usr/local/bin/renew-qsgl-cert.sh >> /var/log/cert-renewal.log 2>&1
```

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æŸ¥çœ‹å½“å‰åŸŸå
cat /etc/envoy-domain.conf

# ä¿®æ”¹åŸŸå
echo "æ–°åŸŸå" > /etc/envoy-domain.conf

# ç”Ÿæˆè¯ä¹¦
/usr/local/bin/renew-qsgl-cert.sh

# é‡å¯ Envoy
docker restart envoy-proxy

# æµ‹è¯•æœåŠ¡
curl -skI https://localhost:8443/ -H "Host: www.$(cat /etc/envoy-domain.conf)"

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/cert-renewal.log
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜: Envoy å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs --tail 50 envoy-proxy

# å¸¸è§é”™è¯¯: "Failed to load incomplete private key"
# åŸå› : EC ç§é’¥ä¸å…¼å®¹
# è§£å†³: é‡æ–°ç”Ÿæˆ RSA è¯ä¹¦
cd /opt/envoy/certs
openssl genrsa -out $(cat /etc/envoy-domain.conf).key 2048
openssl req -new -x509 -key $(cat /etc/envoy-domain.conf).key -sha256 -days 90 \
  -out $(cat /etc/envoy-domain.conf).crt \
  -subj "/CN=*.$(cat /etc/envoy-domain.conf)" \
  -addext "subjectAltName=DNS:$(cat /etc/envoy-domain.conf),DNS:*.$(cat /etc/envoy-domain.conf)"
chmod 644 *.crt && chmod 600 *.key
docker restart envoy-proxy
```

### é—®é¢˜: 8443 ç«¯å£æ— æ³•è®¿é—®
```bash
# æ£€æŸ¥ç«¯å£æ˜ å°„
docker port envoy-proxy

# æ£€æŸ¥é˜²ç«å¢™
iptables -L -n | grep 8443

# æ£€æŸ¥ Envoy æ˜¯å¦è¿è¡Œ
docker ps | grep envoy

# æ£€æŸ¥è¯ä¹¦æ˜¯å¦åŒ¹é…
openssl s_client -connect localhost:8443 -servername www.$(cat /etc/envoy-domain.conf) < /dev/null
```

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ19æ—¥  
**å½“å‰çŠ¶æ€**: âœ… æ­£å¸¸è¿è¡Œ  
**å½“å‰åŸŸå**: qsgl.cn
