<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>åŠ¨æ€åŸŸåè§£æè®¾ç½®</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        #log { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
        label { display: inline-block; width: 80px; }
        input { margin-bottom: 10px; }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
    <h2>åŠ¨æ€åŸŸåè§£æè®¾ç½®</h2>
    <label>å­åŸŸåï¼š</label><input id="subdomain" type="text" placeholder="www æˆ– api ç­‰"><br>
    <label>åŸŸåï¼š</label><input id="domain" type="text" placeholder="your.domain.com"><br>
    <label>åˆ·æ–°æ—¶é—´ï¼š</label><input id="interval" type="number" min="5" value="60"> ç§’<br>
    <label><input id="enableDnsUpdate" type="checkbox"> å¯ç”¨DNSPod APIæ›´æ–° (éœ€è¦localhost:5189æœåŠ¡)</label><br>
    <button id="startBtn">å¼€å§‹</button>

    <hr>
    <h2>ç”³è¯·è¯ä¹¦</h2>
    <label>è¯ä¹¦åŸŸåï¼š</label><input id="certDomain" type="text" placeholder="ä¾‹å¦‚ï¼šqsgl.net æˆ– sub.qsgl.net"><br>
    <label>åŸŸåæœåŠ¡å•†ï¼š</label><input id="provider" type="text" value="DNSPOD" placeholder="DNSPOD / ALIYUN / CLOUDFLARE"><br>
    <label>API KEY IDï¼š</label><input id="apiKeyId" type="text" placeholder="API KEY ID æˆ– CF_Email æˆ–ç•™ç©º(ä»… CF_Token)"><br>
    <label>API å¯†é’¥ï¼š</label><input id="apiKeySecret" type="password" placeholder="API å¯†é’¥ æˆ– CF_Key æˆ– CF_Token"><br>
    <label>CF Account IDï¼š</label><input id="cfAccountId" type="text" placeholder="Cloudflare è´¦å·IDï¼ˆå¯é€‰ï¼‰"><br>
    <button id="applyCertBtn">ç”³è¯·è¯ä¹¦</button>
    <div id="certLog" style="margin-top:10px;color:#333;"></div>

    <h3>åˆ·æ–°è®°å½•ï¼ˆæœ€å10æ¡ï¼‰</h3>
    <div id="log"></div>
    <script>
        let timer = null;
        let logs = [];

        // ä»åœ°å€æ è·å– domain å‚æ•°ï¼Œé»˜è®¤ qsgl.net
        (function initFromQuery() {
            const params = new URLSearchParams(location.search);
            const qDomain = (params.get('domain') || 'qsgl.net').trim();
            const domainInput = document.getElementById('domain');
            const certDomainInput = document.getElementById('certDomain');
            if (!domainInput.value) domainInput.value = qDomain;
            if (!certDomainInput.value) certDomainInput.value = qDomain;
        })();

        function isApexDomain(d) {
            // ç®€å•åˆ¤æ–­ä¸€çº§åŸŸï¼šåªåŒ…å«ä¸€ä¸ªç‚¹ï¼Œä¸”ä¸ä»¥ç‚¹å¼€å¤´/ç»“å°¾
            if (!d) return false;
            const s = d.trim().toLowerCase();
            if (s.startsWith('.') || s.endsWith('.')) return false;
            const first = s.indexOf('.');
            const last = s.lastIndexOf('.');
            return first > 0 && first === last && last < s.length - 1;
        }

        document.getElementById('startBtn').onclick = function() {
            if (timer) clearInterval(timer);
            const domain = document.getElementById('domain').value.trim();
            const interval = parseInt(document.getElementById('interval').value, 10) * 1000;
            if (!domain) { alert('è¯·è¾“å…¥åŸŸå'); return; }
            function refresh() {
                // é»˜è®¤ useProxy=false ä»¥ç»•è¿‡ä»£ç†ï¼Œè·å–çœŸå® WAN IP
                const enableDns = document.getElementById('enableDnsUpdate').checked;
                const subdomain = document.getElementById('subdomain').value.trim();
                let url = '/api/updatehosts?domain=' + encodeURIComponent(domain) + '&useProxy=false&enableDnsUpdate=' + enableDns;
                if (subdomain) {
                    url += '&subdomain=' + encodeURIComponent(subdomain);
                }
                fetch(url)
                    .then(r => r.json())
                    .then(res => {
                        const now = new Date().toLocaleTimeString();
                        const changeIndicator = res.changed ? 'ğŸ”„' : 'âœ“';
                        const ipInfo = res.lastIp && res.lastIp !== res.ip ? 
                            `IPå˜æ›´: ${res.lastIp} â†’ ${res.ip}` : 
                            `IP: ${res.ip}`;
                        
                        let logEntry = `${now} ${changeIndicator} ${ipInfo} - ${res.msg}`;
                        
                        // å¦‚æœæœ‰DNS APIå“åº”ï¼Œåˆ™æ˜¾ç¤º
                        if (res.dnsApiResponse) {
                            logEntry += `<br>&nbsp;&nbsp;ğŸ“¡ DNS APIå“åº”: ${res.dnsApiResponse}`;
                        }
                        
                        logs.unshift(logEntry);
                        logs = logs.slice(0, 10);
                        document.getElementById('log').innerHTML = logs.join('<br>');
                    })
                    .catch(e => {
                        const now = new Date().toLocaleTimeString();
                        logs.unshift(`${now} - è¯·æ±‚å¤±è´¥`);
                        logs = logs.slice(0, 10);
                        document.getElementById('log').innerHTML = logs.join('<br>');
                    });
            }
            refresh();
            timer = setInterval(refresh, interval);
        };

        document.getElementById('applyCertBtn').onclick = function() {
            const d = (document.getElementById('certDomain').value || 'qsgl.net').trim();
            const provider = (document.getElementById('provider').value || 'DNSPOD').trim();
            const apiKeyId = (document.getElementById('apiKeyId').value || '').trim();
            const apiKeySecret = (document.getElementById('apiKeySecret').value || '').trim();
            const cfAccountId = (document.getElementById('cfAccountId').value || '').trim();
            const wantWildcard = isApexDomain(d);

            const body = { domain: d, provider, apiKeyId, apiKeySecret };
            if (cfAccountId) body.cfAccountId = cfAccountId;

            fetch('/api/request-cert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(r => r.json())
            .then(res => {
                const now = new Date().toLocaleTimeString();
                const sub = res.subject || (wantWildcard ? ('*.' + d) : d);
                document.getElementById('certLog').innerText = `${now} - ${res.msg} - ç”³è¯·ä¸»é¢˜: ${sub}`;
            })
            .catch(err => {
                const now = new Date().toLocaleTimeString();
                document.getElementById('certLog').innerText = `${now} - ç”³è¯·å¤±è´¥: ${err}`;
            });
        };
    </script>
 </body>
 </html>