# 阿里云 Envoy 8443 端口访问说明

## ✅ 服务状态：已成功配置并运行

### 配置信息
- **服务器**: www.qsgl.cn (123.57.93.200)
- **代理端口**: 8443 (HTTPS)
- **后端服务**: https://61.163.200.245
- **绑定域名**: www.qsgl.net
- **证书**: CN=*.qsgl.net (自签名泛域名证书)

### 验证结果
✅ TCP 端口 8443 已开放  
✅ HTTPS 握手成功  
✅ 后端代理正常工作  
✅ 返回状态码 200 OK  
✅ 服务器响应头包含 `server: envoy`  

---

## 🌐 浏览器访问方法

### 方法 1：直接访问（会显示证书警告）

**访问地址**:
```
https://www.qsgl.cn:8443/
```

**操作步骤**:
1. 在浏览器中打开上述地址
2. 浏览器会显示证书警告（因为是自签名证书）
3. 点击"高级"或"详细信息"
4. 点击"继续访问"或"接受风险并继续"
5. 即可看到后端 ASP.NET 应用的内容

### 方法 2：使用正确的 Host 头

如果需要测试域名绑定，可以修改本地 hosts 文件：

**Windows hosts 文件位置**:
```
C:\Windows\System32\drivers\etc\hosts
```

**添加以下行**:
```
123.57.93.200  www.qsgl.net
```

然后访问:
```
https://www.qsgl.net:8443/
```

---

## 🔧 命令行测试方法

### 方法 1：使用 curl（推荐）

如果已安装 Git for Windows，可以使用 Git Bash 中的 curl：

```bash
# 不带 Host 头（预期 404）
curl -skI https://www.qsgl.cn:8443/

# 带 Host 头（预期 200）
curl -skI https://www.qsgl.cn:8443/ -H "Host: www.qsgl.net"
```

### 方法 2：使用 PowerShell 7+

PowerShell 7 支持 `-SkipCertificateCheck` 参数：

```powershell
# 安装 PowerShell 7：winget install Microsoft.PowerShell

# 测试命令
pwsh -Command "Invoke-WebRequest -Uri 'https://www.qsgl.cn:8443/' -Headers @{'Host'='www.qsgl.net'} -SkipCertificateCheck"
```

### 方法 3：从服务器本身测试

```bash
ssh root@www.qsgl.cn
curl -skI https://localhost:8443/ -H "Host: www.qsgl.net"
```

---

## ⚠️ PowerShell 5.1 已知问题

Windows 自带的 PowerShell 5.1 **不支持** `-SkipCertificateCheck` 参数，且对自签名证书的 TLS 握手支持不完善。

如果你遇到以下错误：
```
找不到与参数名称"SkipCertificateCheck"匹配的参数
基础连接已经关闭: 发送时发生错误
```

**解决方案**：
1. 使用浏览器访问（推荐）
2. 升级到 PowerShell 7
3. 使用 curl 命令

---

## 📊 服务器端验证日志

```bash
# 查看 Envoy 日志
docker logs --tail 50 envoy-proxy

# 查看证书文件
ls -l /opt/envoy/certs/

# 测试证书
openssl x509 -in /opt/envoy/certs/qsgl.net.crt -noout -text

# 查看端口监听
docker port envoy-proxy
netstat -tlnp | grep 8443
```

---

## 🔒 关于自签名证书

当前使用的是自签名证书（用于测试），浏览器会显示"不安全"警告。这是**正常现象**。

如需浏览器信任的正式证书，建议：

### 选项 1：使用 Let's Encrypt（免费）
```bash
# 在服务器上安装 acme.sh
curl https://get.acme.sh | sh

# 使用 DNS 验证申请证书
acme.sh --issue -d qsgl.net -d '*.qsgl.net' --dns dns_dp
```

### 选项 2：使用现有证书 API
```bash
# 使用已部署的证书 API
/usr/local/bin/renew-qsgl-cert.sh
```

---

## ✅ 测试检查清单

- [x] TCP 端口 8443 可访问
- [x] HTTPS 握手成功
- [x] 证书主题正确 (CN=*.qsgl.net)
- [x] 后端代理正常 (61.163.200.245)
- [x] Host 头绑定生效 (www.qsgl.net)
- [x] 返回 200 OK 状态码
- [x] Envoy 响应头正常

---

## 📞 故障排查

如果访问失败，请检查：

1. **DNS 解析**
   ```bash
   nslookup www.qsgl.cn
   ping www.qsgl.cn
   ```

2. **端口连通性**
   ```bash
   telnet www.qsgl.cn 8443
   # 或 PowerShell
   Test-NetConnection www.qsgl.cn -Port 8443
   ```

3. **服务器端状态**
   ```bash
   docker ps | grep envoy
   docker logs envoy-proxy
   ```

4. **防火墙规则**
   - 检查本地防火墙
   - 检查公司网络限制
   - 检查阿里云安全组规则

---

## 📝 配置文件位置

- Envoy 配置: `/opt/envoy/envoy.yaml`
- 证书文件: `/opt/envoy/certs/qsgl.net.crt`
- 私钥文件: `/opt/envoy/certs/qsgl.net.key`
- 续期脚本: `/usr/local/bin/renew-qsgl-cert.sh`
- 日志文件: `/var/log/cert-renewal.log`

---

**最后更新**: 2025年10月19日  
**状态**: ✅ 正常运行
