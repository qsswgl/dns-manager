<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>åŠ¨æ€åŸŸåè§£æè®¾ç½®</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        #log { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
        label { display: inline-block; width: 80px; }
        input { margin-bottom: 10px; }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
    <h2>åŠ¨æ€åŸŸåè§£æè®¾ç½®</h2>
    <label>å­åŸŸåï¼š</label><input id="subdomain" type="text" placeholder="www æˆ– api ç­‰"><br>
    <label>åŸŸåï¼š</label><input id="domain" type="text" placeholder="your.domain.com"><br>
    <label>åˆ·æ–°æ—¶é—´ï¼š</label><input id="interval" type="number" min="5" value="60"> ç§’<br>
    <label><input id="enableDnsUpdate" type="checkbox" checked> å¯ç”¨DNSPod APIæ›´æ–° (è¿æ¥åˆ° tx.qsgl.net:5190)</label><br>
    <button id="startBtn">å¼€å§‹</button>

    <hr>
    <p>
        <a href="/cert.html" style="text-decoration:none; color:#007cba;">ğŸ“œ è¯ä¹¦ç®¡ç†</a> |
        <a href="/swagger" style="text-decoration:none; color:#007cba;">ğŸ“š API æ–‡æ¡£</a>
    </p>

    <h3>åˆ·æ–°è®°å½•ï¼ˆæœ€å10æ¡ï¼‰</h3>
    <div id="log"></div>
    <script>
        let timer = null;
        let logs = [];

        // ä»åœ°å€æ è·å– domain å‚æ•°ï¼Œé»˜è®¤ qsgl.net
        (function initFromQuery() {
            const params = new URLSearchParams(location.search);
            const qDomain = (params.get('domain') || 'qsgl.net').trim();
            const domainInput = document.getElementById('domain');
            if (!domainInput.value) domainInput.value = qDomain;
        })();

        document.getElementById('startBtn').onclick = function() {
            if (timer) clearInterval(timer);
            const domain = document.getElementById('domain').value.trim();
            const interval = parseInt(document.getElementById('interval').value, 10) * 1000;
            if (!domain) { alert('è¯·è¾“å…¥åŸŸå'); return; }
            function refresh() {
                // é»˜è®¤ useProxy=false ä»¥ç»•è¿‡ä»£ç†ï¼Œè·å–çœŸå® WAN IP
                const enableDns = document.getElementById('enableDnsUpdate').checked;
                const subdomain = document.getElementById('subdomain').value.trim();
                let url = '/api/updatehosts?domain=' + encodeURIComponent(domain) + '&useProxy=false&enableDnsUpdate=' + enableDns;
                if (subdomain) {
                    url += '&subdomain=' + encodeURIComponent(subdomain);
                }
                fetch(url)
                    .then(r => r.json())
                    .then(res => {
                        const now = new Date().toLocaleTimeString();
                        const changeIndicator = res.changed ? 'ğŸ”„' : 'âœ“';
                        const ipInfo = res.lastIp && res.lastIp !== res.ip ? 
                            `IPå˜æ›´: ${res.lastIp} â†’ ${res.ip}` : 
                            `IP: ${res.ip}`;
                        
                        let logEntry = `${now} ${changeIndicator} ${ipInfo} - ${res.msg}`;
                        
                        // æ˜¾ç¤ºDNS APIè°ƒç”¨çŠ¶æ€
                        if (res.dnsApiCalled !== undefined) {
                            logEntry += `<br>&nbsp;&nbsp;ğŸ”§ DNSæ›´æ–°: ${res.dnsCallStatus || 'æœªçŸ¥çŠ¶æ€'}`;
                        }
                        
                        // å¦‚æœæœ‰DNS APIå“åº”ï¼Œåˆ™æ˜¾ç¤º
                        if (res.dnsApiResponse && res.dnsApiResponse !== "æœªè°ƒç”¨ DNS API") {
                            // æˆªæ–­è¿‡é•¿çš„å“åº”å†…å®¹
                            const maxLength = 100;
                            const responseText = res.dnsApiResponse.length > maxLength ? 
                                res.dnsApiResponse.substring(0, maxLength) + '...' : 
                                res.dnsApiResponse;
                            logEntry += `<br>&nbsp;&nbsp;ğŸ“¡ DNS APIå“åº”: ${responseText}`;
                        }
                        
                        logs.unshift(logEntry);
                        logs = logs.slice(0, 10);
                        document.getElementById('log').innerHTML = logs.join('<br>');
                    })
                    .catch(e => {
                        const now = new Date().toLocaleTimeString();
                        logs.unshift(`${now} - è¯·æ±‚å¤±è´¥`);
                        logs = logs.slice(0, 10);
                        document.getElementById('log').innerHTML = logs.join('<br>');
                    });
            }
            refresh();
            timer = setInterval(refresh, interval);
        };


    </script>
 </body>
 </html>